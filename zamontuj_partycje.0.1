#!/bin/bash -x

#skrypt wyszukuje i montuje partycje windosowe

KATALOG_GLOWNY=~/DW/badanie


function sprawdz_czy_dysk_zamontowany() {
    DATA=`date "+%y-%m-%d %H:%M:%S"`
    if [ -n "$(grep $1 /proc/mounts)" ]
    then
	#zapis do loga
  	echo $DATA "- Checking- Partition /dev/${1} mounted already" >> ${KATALOG_GLOWNY}/log.txt
        return 1 #zamontowany
    else
	echo $DATA "- Checking- Partition /dev/${1} not mounted" >> ${KATALOG_GLOWNY}/log.txt
        return 0 #nie zamontowany
    fi 
}

function montujemy() {
  # zmienna $1 przejmuje wartosc argumentu wywolania np. sda1
  # mountujemy w trybie do odczytu -r
  sudo mount -r /dev/"$1" /media/"$1" 
  #zapis do loga
  DATA=`date "+%y-%m-%d %H:%M:%S"`
  echo $DATA "- Partition /dev/${1} mounted in /media/${1}" >> ${KATALOG_GLOWNY}/log.txt
	
}

#wyszukuje wszystkie dyski i partycje
sudo fdisk -l | 
#wyszykuje tylko te windosowe i zapisuje do pliku
grep 'HPFS\|NTFS\|exFAT\|FAT' |
#pobiera pierwsza kolumne i zapisuje do pliku
awk '{ print $1 }' | 
#zapisuje pelna sciezke do dyskow
tee ${KATALOG_GLOWNY}/system_info/partycje_win_fullpath.txt |
#oraz selekcjonuje np. z /dev/sda1 drugi czlon - sda1 i zapisuje
cut -d / -f 3 > ${KATALOG_GLOWNY}/system_info/partycje_win.txt

DATA=`date "+%y-%m-%d %H:%M:%S"`

#jesli plik istnieje lub nie jest pusty
if [ -e ${KATALOG_GLOWNY}/system_info/partycje_win.txt ] && [ -s ${KATALOG_GLOWNY}/system_info/partycje_win.txt ]
then
	echo $DATA "- Found windows partition" >> ${KATALOG_GLOWNY}/log.txt
else
	#zapis loga
	echo $DATA "- No file with info about windows partition or file is empty" >> ${KATALOG_GLOWNY}/log.txt
	exit 1
fi 


#pobiera z pliku nazwy partycji do zamontowania
for PARTYCJA_DO_ZAMONTOWANIA in `cat ${KATALOG_GLOWNY}/system_info/partycje_win.txt`
do
	sprawdz_czy_dysk_zamontowany "$PARTYCJA_DO_ZAMONTOWANIA"
	if [ $? == 0 ] # nie zamontowana
	then
    		#sprawdzamy czy katalog juz istnieje
		#jesli istnieje montujemy 
		if [ -d /media/${PARTYCJA_DO_ZAMONTOWANIA} ]; then 
			montujemy ${PARTYCJA_DO_ZAMONTOWANIA}
		else 
			#jesli nie istnieje tworzymy go
			sudo mkdir /media/${PARTYCJA_DO_ZAMONTOWANIA} 
			#i montujemy
			montujemy ${PARTYCJA_DO_ZAMONTOWANIA}
		fi	
	fi
done





